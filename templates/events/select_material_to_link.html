<!-- templates/events/select_material_to_link.html - Version avec recherche dynamique -->
{% extends "base.html" %}

{% block title %}Sélectionner le matériel à lier{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mt-4 mb-4">
        <i class="fas fa-link"></i> Sélectionner le matériel à lier
    </h2>

    <div class="progress mb-4">
        <div class="progress-bar bg-primary" role="progressbar" style="width: 50%;" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
            Étape 2/4
        </div>
    </div>

    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> Utilisateur sélectionné : <strong>{{ user.GivenName }} {{ user.Surname }}</strong> ({{ user.Username }})
    </div>

    <div class="card">
        <div class="card-header">
            <h5>Rechercher et sélectionner du matériel</h5>
        </div>
        <div class="card-body">
            <!-- Onglets pour les types de matériel -->
            <ul class="nav nav-tabs" id="materialTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="computers-tab" data-bs-toggle="tab" data-bs-target="#computers" type="button" role="tab">
                        <i class="fas fa-laptop"></i> Ordinateurs
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monitors-tab" data-bs-toggle="tab" data-bs-target="#monitors" type="button" role="tab">
                        <i class="fas fa-desktop"></i> Moniteurs
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="peripherals-tab" data-bs-toggle="tab" data-bs-target="#peripherals" type="button" role="tab">
                        <i class="fas fa-keyboard"></i> Périphériques
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="phones-tab" data-bs-toggle="tab" data-bs-target="#phones" type="button" role="tab">
                        <i class="fas fa-mobile-alt"></i> Téléphones
                    </button>
                </li>
            </ul>

            <!-- Contenu des onglets -->
            <div class="tab-content" id="materialTabContent">
                <!-- Onglet Ordinateurs -->
                <div class="tab-pane fade show active" id="computers" role="tabpanel">
                    <div class="material-search-panel" data-material-type="computers">
                        <div class="row mt-3">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control material-search-input"
                                           placeholder="Tapez au moins 4 caractères (nom, numéro de série, inventaire)..."
                                           autocomplete="off">
                                    <button class="btn btn-outline-secondary clear-search-btn" type="button">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    Recherche dans le nom, numéro de série et numéro d'inventaire
                                </small>
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-info selected-count">0 sélectionné(s)</span>
                            </div>
                        </div>

                        <!-- Zone d'état -->
                        <div class="search-state mt-3">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-2"></i>
                                <p>Tapez au moins 4 caractères pour rechercher des ordinateurs</p>
                            </div>
                        </div>

                        <!-- Zone de chargement -->
                        <div class="loading-spinner text-center py-3" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Recherche en cours...</span>
                            </div>
                            <p class="mt-2 text-muted">Recherche en cours...</p>
                        </div>

                        <!-- Résultats de recherche -->
                        <div class="search-results mt-3" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th width="50px">
                                                <input type="checkbox" class="form-check-input select-all-checkbox">
                                            </th>
                                            <th>Nom</th>
                                            <th>N° de série</th>
                                            <th>N° inventaire</th>
                                            <th>Statut</th>
                                        </tr>
                                    </thead>
                                    <tbody class="results-tbody">
                                        <!-- Les résultats apparaîtront ici -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Matériel sélectionné -->
                        <div class="selected-materials mt-3" style="display: none;">
                            <h6><i class="fas fa-check-circle text-success"></i> Matériel sélectionné :</h6>
                            <div class="selected-items-list">
                                <!-- Les éléments sélectionnés apparaîtront ici -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Répéter la même structure pour les autres onglets -->
                <div class="tab-pane fade" id="monitors" role="tabpanel">
                    <div class="material-search-panel" data-material-type="monitors">
                        <!-- Même structure que computers -->
                        <div class="row mt-3">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control material-search-input"
                                           placeholder="Tapez au moins 4 caractères (nom, numéro de série, inventaire)..."
                                           autocomplete="off">
                                    <button class="btn btn-outline-secondary clear-search-btn" type="button">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-info selected-count">0 sélectionné(s)</span>
                            </div>
                        </div>

                        <div class="search-state mt-3">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-2"></i>
                                <p>Tapez au moins 4 caractères pour rechercher des moniteurs</p>
                            </div>
                        </div>

                        <div class="loading-spinner text-center py-3" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Recherche en cours...</span>
                            </div>
                        </div>

                        <div class="search-results mt-3" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th width="50px">
                                                <input type="checkbox" class="form-check-input select-all-checkbox">
                                            </th>
                                            <th>Nom</th>
                                            <th>N° de série</th>
                                            <th>N° inventaire</th>
                                            <th>Statut</th>
                                        </tr>
                                    </thead>
                                    <tbody class="results-tbody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="selected-materials mt-3" style="display: none;">
                            <h6><i class="fas fa-check-circle text-success"></i> Matériel sélectionné :</h6>
                            <div class="selected-items-list">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="peripherals" role="tabpanel">
                    <div class="material-search-panel" data-material-type="peripherals">
                        <!-- Même structure -->
                        <div class="row mt-3">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control material-search-input"
                                           placeholder="Tapez au moins 4 caractères (nom, numéro de série, inventaire)..."
                                           autocomplete="off">
                                    <button class="btn btn-outline-secondary clear-search-btn" type="button">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-info selected-count">0 sélectionné(s)</span>
                            </div>
                        </div>

                        <div class="search-state mt-3">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-2"></i>
                                <p>Tapez au moins 4 caractères pour rechercher des périphériques</p>
                            </div>
                        </div>

                        <div class="loading-spinner text-center py-3" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Recherche en cours...</span>
                            </div>
                        </div>

                        <div class="search-results mt-3" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th width="50px">
                                                <input type="checkbox" class="form-check-input select-all-checkbox">
                                            </th>
                                            <th>Nom</th>
                                            <th>N° de série</th>
                                            <th>N° inventaire</th>
                                            <th>Statut</th>
                                        </tr>
                                    </thead>
                                    <tbody class="results-tbody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="selected-materials mt-3" style="display: none;">
                            <h6><i class="fas fa-check-circle text-success"></i> Matériel sélectionné :</h6>
                            <div class="selected-items-list">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="phones" role="tabpanel">
                    <div class="material-search-panel" data-material-type="phones">
                        <!-- Même structure -->
                        <div class="row mt-3">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control material-search-input"
                                           placeholder="Tapez au moins 4 caractères (nom, numéro de série, inventaire)..."
                                           autocomplete="off">
                                    <button class="btn btn-outline-secondary clear-search-btn" type="button">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-info selected-count">0 sélectionné(s)</span>
                            </div>
                        </div>

                        <div class="search-state mt-3">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-2"></i>
                                <p>Tapez au moins 4 caractères pour rechercher des téléphones</p>
                            </div>
                        </div>

                        <div class="loading-spinner text-center py-3" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Recherche en cours...</span>
                            </div>
                        </div>

                        <div class="search-results mt-3" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th width="50px">
                                                <input type="checkbox" class="form-check-input select-all-checkbox">
                                            </th>
                                            <th>Nom</th>
                                            <th>N° de série</th>
                                            <th>N° inventaire</th>
                                            <th>Statut</th>
                                        </tr>
                                    </thead>
                                    <tbody class="results-tbody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="selected-materials mt-3" style="display: none;">
                            <h6><i class="fas fa-check-circle text-success"></i> Matériel sélectionné :</h6>
                            <div class="selected-items-list">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire pour l'envoi des données -->
    <form method="POST" action="{{ url_for('select_material_to_link', user_id=user.id) }}" id="materialSelectionForm">
        <input type="hidden" name="material_type" id="current_material_type" value="computers">
        <!-- Les IDs du matériel sélectionné seront ajoutés ici dynamiquement -->
        <div id="hidden_material_ids"></div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary" id="submit_btn" disabled>
                <i class="fas fa-link"></i> Lier le matériel sélectionné
            </button>
            <a href="{{ url_for('select_user') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour à la sélection d'utilisateur
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    let searchTimeouts = {}; // Un timeout par type de matériel
    let selectedMaterials = {}; // Matériel sélectionné par type
    let currentMaterialType = 'computers';

    // Initialiser les structures de données pour chaque type
    ['computers', 'monitors', 'peripherals', 'phones'].forEach(type => {
        selectedMaterials[type] = new Map();
    });

    // Fonction pour échapper le HTML (sécurité)
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Fonction pour obtenir le panneau de recherche actif
    function getCurrentPanel() {
        return document.querySelector('.material-search-panel[data-material-type="' + currentMaterialType + '"]');
    }

    // Fonction pour mettre à jour le compteur d'éléments sélectionnés
    function updateSelectedCount() {
        const panel = getCurrentPanel();
        const countBadge = panel.querySelector('.selected-count');
        const count = selectedMaterials[currentMaterialType].size;
        countBadge.textContent = `${count} sélectionné(s)`;
        countBadge.className = count > 0 ? 'badge bg-success selected-count' : 'badge bg-info selected-count';

        // Mettre à jour le bouton de soumission
        updateSubmitButton();
    }

    // Fonction pour mettre à jour le bouton de soumission
    function updateSubmitButton() {
        const submitBtn = document.getElementById('submit_btn');
        let totalSelected = 0;
        Object.values(selectedMaterials).forEach(map => {
            totalSelected += map.size;
        });
        submitBtn.disabled = totalSelected === 0;
    }

    // Fonction pour afficher l'état de chargement
    function showLoading(panel) {
        panel.querySelector('.search-state').style.display = 'none';
        panel.querySelector('.loading-spinner').style.display = 'block';
        panel.querySelector('.search-results').style.display = 'none';
    }

    // Fonction pour masquer le chargement
    function hideLoading(panel) {
        panel.querySelector('.loading-spinner').style.display = 'none';
    }

    // Fonction pour afficher l'état de démarrage
    function showStartState(panel) {
        panel.querySelector('.search-state').style.display = 'block';
        panel.querySelector('.loading-spinner').style.display = 'none';
        panel.querySelector('.search-results').style.display = 'none';
    }

    // Fonction pour afficher les résultats
    function displayResults(panel, materials) {
        hideLoading(panel);

        const resultsContainer = panel.querySelector('.search-results');
        const tbody = panel.querySelector('.results-tbody');

        tbody.innerHTML = '';

        if (materials.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted py-3">
                        <i class="fas fa-search-minus"></i> Aucun matériel trouvé
                    </td>
                </tr>
            `;
        } else {
            materials.forEach(material => {
                const row = document.createElement('tr');
                const isAlreadyLinkedToUser = material.Username === '{{ user.Username }}';
                const isLinkedToOther = material.is_linked && material.Username && material.Username !== '{{ user.Username }}';
                const isSelected = selectedMaterials[currentMaterialType].has(material.id);

                // Définir les classes CSS selon le statut
                let rowClass = '';
                let statusBadge = '';
                let checkboxDisabled = '';

                if (isAlreadyLinkedToUser) {
                    rowClass = 'table-success';
                    statusBadge = '<span class="badge bg-success">Déjà lié à cet utilisateur</span>';
                } else if (isLinkedToOther) {
                    rowClass = 'table-warning';
                    statusBadge = `<span class="badge bg-warning">Lié à ${escapeHtml(material.Username)}</span>`;
                    checkboxDisabled = 'disabled';
                } else {
                    statusBadge = '<span class="badge bg-secondary">Libre</span>';
                }

                row.className = rowClass;
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="form-check-input material-checkbox"
                               value="${material.id}"
                               ${isSelected ? 'checked' : ''}
                               ${checkboxDisabled}
                               data-material='${JSON.stringify(material)}'>
                    </td>
                    <td>
                        <strong>${escapeHtml(material.name || 'N/A')}</strong>
                    </td>
                    <td>
                        <code class="small">${escapeHtml(material.serial || 'N/A')}</code>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">${escapeHtml(material.otherserial || 'N/A')}</span>
                    </td>
                    <td>
                        ${statusBadge}
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        resultsContainer.style.display = 'block';
        panel.querySelector('.search-state').style.display = 'none';

        // Ajouter les gestionnaires d'événements aux checkboxes
        attachCheckboxListeners(panel);

        // Mettre à jour la checkbox "Tout sélectionner"
        updateSelectAllCheckbox(panel);
    }

    // Fonction pour attacher les gestionnaires aux checkboxes
    function attachCheckboxListeners(panel) {
        const checkboxes = panel.querySelectorAll('.material-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const material = JSON.parse(this.dataset.material);

                if (this.checked) {
                    selectedMaterials[currentMaterialType].set(material.id, material);
                } else {
                    selectedMaterials[currentMaterialType].delete(material.id);
                }

                updateSelectedCount();
                updateSelectedMaterialsList();
                updateSelectAllCheckbox(panel);
            });
        });
    }

    // Fonction pour mettre à jour la checkbox "Tout sélectionner"
    function updateSelectAllCheckbox(panel) {
        const selectAllCheckbox = panel.querySelector('.select-all-checkbox');
        const materialCheckboxes = panel.querySelectorAll('.material-checkbox:not([disabled])');
        const checkedCheckboxes = panel.querySelectorAll('.material-checkbox:not([disabled]):checked');

        if (materialCheckboxes.length === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (checkedCheckboxes.length === materialCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else if (checkedCheckboxes.length > 0) {
            selectAllCheckbox.indeterminate = true;
            selectAllCheckbox.checked = false;
        } else {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        }
    }

    // Fonction pour mettre à jour la liste du matériel sélectionné
    function updateSelectedMaterialsList() {
        const panel = getCurrentPanel();
        const selectedContainer = panel.querySelector('.selected-materials');
        const selectedList = panel.querySelector('.selected-items-list');

        const materials = Array.from(selectedMaterials[currentMaterialType].values());

        if (materials.length === 0) {
            selectedContainer.style.display = 'none';
        } else {
            selectedList.innerHTML = '';

            materials.forEach(material => {
                const item = document.createElement('div');
                item.className = 'alert alert-success d-flex justify-content-between align-items-center py-2 mb-2';
                item.innerHTML = `
                    <div>
                        <strong>${escapeHtml(material.name)}</strong>
                        <small class="text-muted d-block">
                            ${material.serial ? 'S/N: ' + escapeHtml(material.serial) : ''}
                            ${material.otherserial ? ' • Inv: ' + escapeHtml(material.otherserial) : ''}
                        </small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-material-btn"
                            data-material-id="${material.id}">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                selectedList.appendChild(item);
            });

            // Ajouter les gestionnaires pour les boutons de suppression
            selectedList.querySelectorAll('.remove-material-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const materialId = parseInt(this.dataset.materialId);
                    selectedMaterials[currentMaterialType].delete(materialId);

                    // Décocher la checkbox correspondante
                    const checkbox = panel.querySelector(`input[value="${materialId}"]`);
                    if (checkbox) checkbox.checked = false;

                    updateSelectedCount();
                    updateSelectedMaterialsList();
                    updateSelectAllCheckbox(panel);
                });
            });

            selectedContainer.style.display = 'block';
        }
    }

    // Fonction pour effectuer la recherche
    function performSearch(panel, searchTerm) {
        const materialType = panel.dataset.materialType;

        if (searchTerm.length < 4) {
            showStartState(panel);
            return;
        }

        showLoading(panel);

        // Requête AJAX pour rechercher le matériel
        fetch(`{{ url_for('api_workflow_search_materials') }}?material_type=${materialType}&q=${encodeURIComponent(searchTerm)}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur de recherche');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                // Limiter à 10 résultats maximum
                const limitedMaterials = data.materials.slice(0, 10);
                displayResults(panel, limitedMaterials);
            } else {
                throw new Error(data.message || 'Erreur de recherche');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            hideLoading(panel);
            const tbody = panel.querySelector('.results-tbody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger py-3">
                        <i class="fas fa-exclamation-triangle"></i> Erreur lors de la recherche
                    </td>
                </tr>
            `;
            panel.querySelector('.search-results').style.display = 'block';
        });
    }

    // Initialiser les gestionnaires pour tous les panneaux
    document.querySelectorAll('.material-search-panel').forEach(panel => {
        const materialType = panel.dataset.materialType;
        const searchInput = panel.querySelector('.material-search-input');
        const clearBtn = panel.querySelector('.clear-search-btn');
        const selectAllCheckbox = panel.querySelector('.select-all-checkbox');

        // Gestionnaire pour la recherche en temps réel
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.trim();

            // Annuler le timeout précédent pour ce type
            clearTimeout(searchTimeouts[materialType]);

            // Définir un nouveau timeout
            searchTimeouts[materialType] = setTimeout(() => {
                performSearch(panel, searchTerm);
            }, 400);
        });

        // Gestionnaire pour le bouton d'effacement
        clearBtn.addEventListener('click', function() {
            searchInput.value = '';
            showStartState(panel);
        });

        // Gestionnaire pour "Tout sélectionner"
        selectAllCheckbox.addEventListener('change', function() {
            const materialCheckboxes = panel.querySelectorAll('.material-checkbox:not([disabled])');

            materialCheckboxes.forEach(checkbox => {
                if (this.checked) {
                    checkbox.checked = true;
                    const material = JSON.parse(checkbox.dataset.material);
                    selectedMaterials[currentMaterialType].set(material.id, material);
                } else {
                    checkbox.checked = false;
                    const material = JSON.parse(checkbox.dataset.material);
                    selectedMaterials[currentMaterialType].delete(material.id);
                }
            });

            updateSelectedCount();
            updateSelectedMaterialsList();
        });
    });

    // Gestionnaire pour le changement d'onglet
    document.querySelectorAll('#materialTab button[data-bs-toggle="tab"]').forEach(tabBtn => {
        tabBtn.addEventListener('shown.bs.tab', function(event) {
            // Extraire le type de matériel depuis l'ID de l'onglet
            currentMaterialType = event.target.id.replace('-tab', '');

            // Mettre à jour le champ caché
            document.getElementById('current_material_type').value = currentMaterialType;

            // Mettre à jour le compteur
            updateSelectedCount();

            // Mettre à jour la liste des éléments sélectionnés
            updateSelectedMaterialsList();
        });
    });

    // Gestionnaire pour la soumission du formulaire
    document.getElementById('materialSelectionForm').addEventListener('submit', function(e) {
        // Vider les champs cachés précédents
        const hiddenContainer = document.getElementById('hidden_material_ids');
        hiddenContainer.innerHTML = '';

        // Ajouter tous les IDs sélectionnés pour le type actuel
        const selectedIds = Array.from(selectedMaterials[currentMaterialType].keys());

        if (selectedIds.length === 0) {
            e.preventDefault();
            alert('Veuillez sélectionner au moins un élément de matériel');
            return false;
        }

        selectedIds.forEach(id => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'material_ids';
            hiddenInput.value = id;
            hiddenContainer.appendChild(hiddenInput);
        });
    });

    // Initialiser l'état de démarrage pour tous les panneaux
    document.querySelectorAll('.material-search-panel').forEach(panel => {
        showStartState(panel);
    });
});
</script>
{% endblock %}